<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Model Validation and Units · ModelingToolkit.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://mtk.sciml.ai/stable/basics/Validation/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="ModelingToolkit.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ModelingToolkit.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Symbolic Modeling Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/ode_modeling/">Composing Ordinary Differential Equations</a></li><li><a class="tocitem" href="../../tutorials/spring_mass/">Component-Based Modeling a Spring-Mass System</a></li><li><a class="tocitem" href="../../tutorials/acausal_components/">Acausal Component-Based Modeling the RC Circuit</a></li><li><a class="tocitem" href="../../tutorials/higher_order/">Automatic Transformation of Nth Order ODEs to 1st Order ODEs</a></li><li><a class="tocitem" href="../../tutorials/tearing_parallelism/">Exposing More Parallelism By Tearing Algebraic Equations in ODESystems</a></li><li><a class="tocitem" href="../../tutorials/nonlinear/">Modeling Nonlinear Systems</a></li><li><a class="tocitem" href="../../tutorials/optimization/">Modeling Optimization Problems</a></li><li><a class="tocitem" href="../../tutorials/stochastic_diffeq/">Modeling with Stochasticity</a></li><li><a class="tocitem" href="../../tutorials/nonlinear_optimal_control/">Nonlinear Optimal Control</a></li></ul></li><li><span class="tocitem">ModelingToolkitize Tutorials</span><ul><li><a class="tocitem" href="../../mtkitize_tutorials/modelingtoolkitize/">Automatically Accelerating ODEProblem Code</a></li><li><a class="tocitem" href="../../mtkitize_tutorials/modelingtoolkitize_index_reduction/">Automated Index Reduction of DAEs</a></li></ul></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../AbstractSystem/">The AbstractSystem Interface</a></li><li><a class="tocitem" href="../ContextualVariables/">Contextual Variable Types</a></li><li><a class="tocitem" href="../Composition/">Composing Models and Building Reusable Components</a></li><li class="is-active"><a class="tocitem" href>Model Validation and Units</a><ul class="internal"><li><a class="tocitem" href="#Assigning-Units"><span>Assigning Units</span></a></li><li><a class="tocitem" href="#Unit-Validation-and-Inspection"><span>Unit Validation &amp; Inspection</span></a></li><li><a class="tocitem" href="#User-Defined-Registered-Functions-and-Types"><span>User-Defined Registered Functions and Types</span></a></li><li><a class="tocitem" href="#Unitful-Literals"><span><code>Unitful</code> Literals</span></a></li><li><a class="tocitem" href="#Other-Restrictions"><span>Other Restrictions</span></a></li><li><a class="tocitem" href="#Troubleshooting-and-Gotchas"><span>Troubleshooting &amp; Gotchas</span></a></li><li><a class="tocitem" href="#Parameter-and-Initial-Condition-Values"><span>Parameter &amp; Initial Condition Values</span></a></li></ul></li><li><a class="tocitem" href="../DependencyGraphs/">Dependency Graphs</a></li><li><a class="tocitem" href="../FAQ/">Frequently Asked Questions</a></li></ul></li><li><span class="tocitem">System Types</span><ul><li><a class="tocitem" href="../../systems/ODESystem/">ODESystem</a></li><li><a class="tocitem" href="../../systems/SDESystem/">SDESystem</a></li><li><a class="tocitem" href="../../systems/JumpSystem/">JumpSystem</a></li><li><a class="tocitem" href="../../systems/NonlinearSystem/">NonlinearSystem</a></li><li><a class="tocitem" href="../../systems/OptimizationSystem/">OptimizationSystem</a></li><li><a class="tocitem" href="../../systems/ControlSystem/">ControlSystem</a></li><li><a class="tocitem" href="../../systems/PDESystem/">PDESystem</a></li></ul></li><li><a class="tocitem" href="../../comparison/">Comparison of ModelingToolkit vs Equation-Based Modeling Languages</a></li><li><a class="tocitem" href="../../internals/">Internal Details</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basics</a></li><li class="is-active"><a href>Model Validation and Units</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Model Validation and Units</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/SciML/ModelingToolkit.jl/blob/master/docs/src/basics/Validation.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="units"><a class="docs-heading-anchor" href="#units">Model Validation and Units</a><a id="units-1"></a><a class="docs-heading-anchor-permalink" href="#units" title="Permalink"></a></h1><p>ModelingToolkit.jl provides extensive functionality for model validation and unit checking. This is done by providing metadata to the variable types and then running the validation functions which identify malformed systems and non-physical equations. This approach provides high performance and compatibility with numerical solvers.</p><h2 id="Assigning-Units"><a class="docs-heading-anchor" href="#Assigning-Units">Assigning Units</a><a id="Assigning-Units-1"></a><a class="docs-heading-anchor-permalink" href="#Assigning-Units" title="Permalink"></a></h2><p>Units may assigned with the following syntax. </p><pre><code class="language-julia hljs">using ModelingToolkit, Unitful
@variables t [unit = u&quot;s&quot;] x(t) [unit = u&quot;m&quot;] g(t) w(t) [unit = &quot;Hz&quot;]

@variables(t, [unit = u&quot;s&quot;], x(t), [unit = u&quot;m&quot;], g(t), w(t), [unit = &quot;Hz&quot;])

@variables(begin
t, [unit = u&quot;s&quot;],
x(t), [unit = u&quot;m&quot;],
g(t),
w(t), [unit = &quot;Hz&quot;]
end)

# Simultaneously set default value (use plain numbers, not quantities)
@variable x=10 [unit = u&quot;m&quot;]

# Symbolic array: unit applies to all elements
@variable x[1:3] [unit = u&quot;m&quot;]</code></pre><p>Do not use <code>quantities</code> such as  <code>1u&quot;s&quot;</code>, <code>1/u&quot;s&quot;</code> or <code>u&quot;1/s&quot;</code> as these will result in errors; instead use <code>u&quot;s&quot;</code>, <code>u&quot;s^-1&quot;</code>, or <code>u&quot;s&quot;^-1</code>. </p><h2 id="Unit-Validation-and-Inspection"><a class="docs-heading-anchor" href="#Unit-Validation-and-Inspection">Unit Validation &amp; Inspection</a><a id="Unit-Validation-and-Inspection-1"></a><a class="docs-heading-anchor-permalink" href="#Unit-Validation-and-Inspection" title="Permalink"></a></h2><p>Unit validation of equations happens automatically when creating a system. However, for debugging purposes one may wish to validate the equations directly using <code>validate</code>.</p><article class="docstring"><header><a class="docstring-binding" id="ModelingToolkit.validate" href="#ModelingToolkit.validate"><code>ModelingToolkit.validate</code></a> — <span class="docstring-category">Function</span></header><section><div><p>Returns true iff units of equations are valid.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/SciML/ModelingToolkit.jl/blob/3bf4b02a226d50dfae2ea8370a0b0e19dd1cceac/src/systems/validation.jl#L191">source</a></section></article><p>Inside, <code>validate</code> uses <code>get_unit</code>, which may be directly applied to any term. Note that <code>validate</code> will not throw an error in the event of incompatible units, but <code>get_unit</code> will. If you would rather receive a warning instead of an error, use <code>safe_get_unit</code> which will yield <code>nothing</code> in the event of an error. Unit agreement is tested with <code>ModelingToolkit.equivalent(u1,u2)</code>. </p><article class="docstring"><header><a class="docstring-binding" id="ModelingToolkit.get_unit" href="#ModelingToolkit.get_unit"><code>ModelingToolkit.get_unit</code></a> — <span class="docstring-category">Function</span></header><section><div><p>Find the unit of a symbolic item.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/SciML/ModelingToolkit.jl/blob/3bf4b02a226d50dfae2ea8370a0b0e19dd1cceac/src/systems/validation.jl#L36">source</a></section></article><p>Example usage below. Note that <code>ModelingToolkit</code> does not force unit conversions to preferred units in the event of nonstandard combinations – it merely checks that the equations are consistent. </p><pre><code class="language-julia hljs">using ModelingToolkit, Unitful
@parameters τ [unit = u&quot;ms&quot;]
@variables t [unit = u&quot;ms&quot;] E(t) [unit = u&quot;kJ&quot;] P(t) [unit = u&quot;MW&quot;]
D = Differential(t)
eqs = eqs = [D(E) ~ P - E/τ,
                0 ~ P       ]
ModelingToolkit.validate(eqs) #Returns true
ModelingToolkit.validate(eqs[1]) #Returns true
ModelingToolkit.get_unit(eqs[1].rhs) #Returns u&quot;kJ ms^-1&quot;</code></pre><p>An example of an inconsistent system: at present, <code>ModelingToolkit</code> requires that the units of all terms in an equation or sum to be equal-valued (<code>ModelingToolkit.equivalent(u1,u2)</code>), rather that simply dimensionally consistent. In the future, the validation stage may be upgraded to support the insertion of conversion factors into the equations. </p><pre><code class="language-julia hljs">using ModelingToolkit, Unitful
@parameters τ [unit = u&quot;ms&quot;]
@variables t [unit = u&quot;ms&quot;] E(t) [unit = u&quot;J&quot;] P(t) [unit = u&quot;MW&quot;]
D = Differential(t)
eqs = eqs = [D(E) ~ P - E/τ,
                0 ~ P       ]
ModelingToolkit.validate(eqs) #Returns false while displaying a warning message</code></pre><h2 id="User-Defined-Registered-Functions-and-Types"><a class="docs-heading-anchor" href="#User-Defined-Registered-Functions-and-Types">User-Defined Registered Functions and Types</a><a id="User-Defined-Registered-Functions-and-Types-1"></a><a class="docs-heading-anchor-permalink" href="#User-Defined-Registered-Functions-and-Types" title="Permalink"></a></h2><p>In order to validate user-defined types and <code>register</code>ed functions, specialize <code>get_unit</code>.  Single-parameter calls to <code>get_unit</code> expect an object type, while two-parameter calls expect a function type as the first argument, and a vector of arguments as the  second argument.</p><pre><code class="language-julia hljs">using ModelingToolkit
# Composite type parameter in registered function
@parameters t
D = Differential(t)
struct NewType
    f
end
@register dummycomplex(complex::Num, scalar)
dummycomplex(complex, scalar) = complex.f - scalar

c = NewType(1)
MT.get_unit(x::NewType) = MT.get_unit(x.f)
function MT.get_unit(op::typeof(dummycomplex),args)
    argunits = MT.get_unit.(args)
    MT.get_unit(-,args)
end

sts = @variables a(t)=0 [unit = u&quot;cm&quot;]
ps = @parameters s=-1 [unit = u&quot;cm&quot;] c=c [unit = u&quot;cm&quot;]
eqs = [D(a) ~ dummycomplex(c, s);]
sys = ODESystem(eqs, t, [sts...;], [ps...;], name=:sys)
sys_simple = structural_simplify(sys)</code></pre><h2 id="Unitful-Literals"><a class="docs-heading-anchor" href="#Unitful-Literals"><code>Unitful</code> Literals</a><a id="Unitful-Literals-1"></a><a class="docs-heading-anchor-permalink" href="#Unitful-Literals" title="Permalink"></a></h2><p>In order for a function to work correctly during both validation &amp; execution, the function must be unit-agnostic. That is, no unitful literals may be used. Any unitful quantity must either be a <code>parameter</code> or <code>variable</code>. For example, these equations will not validate successfully. </p><pre><code class="language-julia hljs">using ModelingToolkit, Unitful
@variables t [unit = u&quot;ms&quot;] E(t) [unit = u&quot;J&quot;] P(t) [unit = u&quot;MW&quot;]
D = Differential(t)
eqs = [D(E) ~ P - E/1u&quot;ms&quot;   ]
ModelingToolkit.validate(eqs) #Returns false while displaying a warning message

myfunc(E) = E/1u&quot;ms&quot;
eqs = [D(E) ~ P - myfunc(E) ]
ModelingToolkit.validate(eqs) #Returns false while displaying a warning message</code></pre><p>Instead, they should be parameterized:</p><pre><code class="language-julia hljs">using ModelingToolkit, Unitful
@parameters τ [unit = u&quot;ms&quot;]
@variables t [unit = u&quot;ms&quot;] E(t) [unit = u&quot;kJ&quot;] P(t) [unit = u&quot;MW&quot;]
D = Differential(t)
eqs = [D(E) ~ P - E/τ]
ModelingToolkit.validate(eqs) #Returns true

myfunc(E,τ) = E/τ 
eqs = [D(E) ~ P - myfunc(E,τ)]
ModelingToolkit.validate(eqs) #Returns true</code></pre><p>It is recommended <em>not</em> to circumvent unit validation by specializing user-defined functions on <code>Unitful</code> arguments vs. <code>Numbers</code>. This both fails to take advantage of <code>validate</code> for ensuring correctness, and may cause in errors in the future when <code>ModelingToolkit</code> is extended to support eliminating <code>Unitful</code> literals from functions.</p><h2 id="Other-Restrictions"><a class="docs-heading-anchor" href="#Other-Restrictions">Other Restrictions</a><a id="Other-Restrictions-1"></a><a class="docs-heading-anchor-permalink" href="#Other-Restrictions" title="Permalink"></a></h2><p><code>Unitful</code> provides non-scalar units such as <code>dBm</code>, <code>°C</code>, etc. At this time, <code>ModelingToolkit</code> only supports scalar quantities. Additionally, angular degrees (<code>°</code>) are not supported because trigonometric functions will treat plain numerical values as radians, which would lead systems validated using degrees to behave erroneously when being solved. </p><h2 id="Troubleshooting-and-Gotchas"><a class="docs-heading-anchor" href="#Troubleshooting-and-Gotchas">Troubleshooting &amp; Gotchas</a><a id="Troubleshooting-and-Gotchas-1"></a><a class="docs-heading-anchor-permalink" href="#Troubleshooting-and-Gotchas" title="Permalink"></a></h2><p>If a system fails to validate due to unit issues, at least one warning message will appear, including a line number as well as the unit types and expressions that were in conflict. Some system constructors re-order equations before the unit checking can be done, in which case the equation numbers may be inaccurate. The printed expression that the problem resides in is always correctly shown.</p><p>Symbolic exponents for unitful variables <em>are</em> supported (ex: <code>P^γ</code> in thermodynamics). However, this means that <code>ModelingToolkit</code> cannot reduce such expressions to <code>Unitful.Unitlike</code> subtypes at validation time because the exponent value is not available. In this case <code>ModelingToolkit.get_unit</code> is type-unstable, yielding a symbolic result, which can still be checked for symbolic equality with <code>ModelingToolkit.equivalent</code>. </p><h2 id="Parameter-and-Initial-Condition-Values"><a class="docs-heading-anchor" href="#Parameter-and-Initial-Condition-Values">Parameter &amp; Initial Condition Values</a><a id="Parameter-and-Initial-Condition-Values-1"></a><a class="docs-heading-anchor-permalink" href="#Parameter-and-Initial-Condition-Values" title="Permalink"></a></h2><p>Parameter and initial condition values are supplied to problem constructors as plain numbers, with the understanding that they have been converted to the appropriate units. This is done for simplicity of interfacing with optimization solvers. Some helper function for dealing with value maps:</p><pre><code class="language-julia hljs">remove_units(p::Dict) = Dict(k =&gt; Unitful.ustrip(ModelingToolkit.get_unit(k),v) for (k,v) in p)
add_units(p::Dict) = Dict(k =&gt; v*ModelingToolkit.get_unit(k) for (k,v) in p)</code></pre><p>Recommended usage:</p><pre><code class="language-julia hljs">pars = @parameters τ [unit = u&quot;ms&quot;]
p = Dict(τ =&gt; 1u&quot;ms&quot;)
ODEProblem(sys,remove_units(u0),tspan,remove_units(p))</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Composition/">« Composing Models and Building Reusable Components</a><a class="docs-footer-nextpage" href="../DependencyGraphs/">Dependency Graphs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.6 on <span class="colophon-date" title="Thursday 23 September 2021 03:48">Thursday 23 September 2021</span>. Using Julia version 1.6.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
