<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Working with Precompilation and Binary Building · ModelingToolkit.jl</title><meta name="title" content="Working with Precompilation and Binary Building · ModelingToolkit.jl"/><meta property="og:title" content="Working with Precompilation and Binary Building · ModelingToolkit.jl"/><meta property="twitter:title" content="Working with Precompilation and Binary Building · ModelingToolkit.jl"/><meta name="description" content="Documentation for ModelingToolkit.jl."/><meta property="og:description" content="Documentation for ModelingToolkit.jl."/><meta property="twitter:description" content="Documentation for ModelingToolkit.jl."/><meta property="og:url" content="https://docs.sciml.ai/ModelingToolkit/stable/basics/Precompilation/"/><meta property="twitter:url" content="https://docs.sciml.ai/ModelingToolkit/stable/basics/Precompilation/"/><link rel="canonical" href="https://docs.sciml.ai/ModelingToolkit/stable/basics/Precompilation/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="ModelingToolkit.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ModelingToolkit.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../tutorials/ode_modeling/">Getting Started with ModelingToolkit.jl</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/acausal_components/">Acausal Component-Based Modeling</a></li><li><a class="tocitem" href="../../tutorials/nonlinear/">Modeling Nonlinear Systems</a></li><li><a class="tocitem" href="../../tutorials/initialization/">Initialization of ODESystems</a></li><li><a class="tocitem" href="../../tutorials/optimization/">Modeling Optimization Problems</a></li><li><a class="tocitem" href="../../tutorials/modelingtoolkitize/">Modelingtoolkitize: Automatically Translating Numerical to Symbolic Code</a></li><li><a class="tocitem" href="../../tutorials/programmatically_generating/">Programmatically Generating and Scripting ODESystems</a></li><li><a class="tocitem" href="../../tutorials/stochastic_diffeq/">Modeling with Stochasticity</a></li><li><a class="tocitem" href="../../tutorials/discrete_system/">(Experimental) Modeling Discrete Systems</a></li><li><a class="tocitem" href="../../tutorials/parameter_identifiability/">Parameter Identifiability in ODE Models</a></li><li><a class="tocitem" href="../../tutorials/change_independent_variable/">Changing the independent variable of ODEs</a></li><li><a class="tocitem" href="../../tutorials/bifurcation_diagram_computation/">Bifurcation Diagrams</a></li><li><a class="tocitem" href="../../tutorials/SampledData/">Clocks and Sampled-Data Systems</a></li><li><a class="tocitem" href="../../tutorials/domain_connections/">Domains</a></li><li><a class="tocitem" href="../../tutorials/callable_params/">Callable parameters and interpolating data</a></li><li><a class="tocitem" href="../../tutorials/linear_analysis/">Linear Analysis</a></li><li><a class="tocitem" href="../../tutorials/fmi/">Importing FMUs</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Basic Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/higher_order/">Automatic Transformation of Nth Order ODEs to 1st Order ODEs</a></li><li><a class="tocitem" href="../../examples/spring_mass/">Component-Based Modeling of a Spring-Mass System</a></li><li><a class="tocitem" href="../../examples/modelingtoolkitize_index_reduction/">Automated Index Reduction of DAEs</a></li><li><a class="tocitem" href="../../examples/remake/">Optimizing through an ODE solve and re-creating MTK Problems</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Advanced Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../examples/tearing_parallelism/">Exposing More Parallelism By Tearing Algebraic Equations in ODESystems</a></li><li><a class="tocitem" href="../../examples/sparse_jacobians/">Automated Sparse Analytical Jacobians</a></li><li><a class="tocitem" href="../../examples/perturbation/">Symbolic-Numeric Perturbation Theory for ODEs</a></li></ul></li></ul></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../AbstractSystem/">The AbstractSystem Interface</a></li><li><a class="tocitem" href="../ContextualVariables/">Contextual Variable Types</a></li><li><a class="tocitem" href="../Variable_metadata/">Symbolic Metadata</a></li><li><a class="tocitem" href="../Composition/">Composing Models and Building Reusable Components</a></li><li><a class="tocitem" href="../Events/">Event Handling and Callback Functions</a></li><li><a class="tocitem" href="../Linearization/">Linearization</a></li><li><a class="tocitem" href="../InputOutput/">Input output</a></li><li><a class="tocitem" href="../MTKLanguage/">ModelingToolkit Language: Modeling with <code>@mtkmodel</code>, <code>@connectors</code> and <code>@mtkbuild</code></a></li><li><a class="tocitem" href="../Validation/">Model Validation and Units</a></li><li><a class="tocitem" href="../Debugging/">Debugging</a></li><li><a class="tocitem" href="../DependencyGraphs/">Dependency Graphs</a></li><li class="is-active"><a class="tocitem" href>Working with Precompilation and Binary Building</a><ul class="internal"><li><a class="tocitem" href="#tl;dr,-I-just-want-precompilation-to-work"><span>tl;dr, I just want precompilation to work</span></a></li><li><a class="tocitem" href="#I&#39;m-doing-something-fancier-and-need-a-bit-more-of-an-explanation"><span>I&#39;m doing something fancier and need a bit more of an explanation</span></a></li></ul></li><li><a class="tocitem" href="../FAQ/">Frequently Asked Questions</a></li></ul></li><li><span class="tocitem">System Types</span><ul><li><a class="tocitem" href="../../systems/ODESystem/">ODESystem</a></li><li><a class="tocitem" href="../../systems/SDESystem/">SDESystem</a></li><li><a class="tocitem" href="../../systems/JumpSystem/">JumpSystem</a></li><li><a class="tocitem" href="../../systems/NonlinearSystem/">NonlinearSystem</a></li><li><a class="tocitem" href="../../systems/OptimizationSystem/">OptimizationSystem</a></li><li><a class="tocitem" href="../../systems/PDESystem/">PDESystem</a></li><li><a class="tocitem" href="../../systems/DiscreteSystem/">DiscreteSystem</a></li><li><a class="tocitem" href="../../systems/ImplicitDiscreteSystem/">ImplicitDiscreteSystem</a></li></ul></li><li><a class="tocitem" href="../../comparison/">Comparison of ModelingToolkit vs Equation-Based and Block Modeling Languages</a></li><li><a class="tocitem" href="../../internals/">Internal Details</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basics</a></li><li class="is-active"><a href>Working with Precompilation and Binary Building</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Working with Precompilation and Binary Building</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SciML/ModelingToolkit.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SciML/ModelingToolkit.jl/blob/master/docs/src/basics/Precompilation.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Working-with-Precompilation-and-Binary-Building"><a class="docs-heading-anchor" href="#Working-with-Precompilation-and-Binary-Building">Working with Precompilation and Binary Building</a><a id="Working-with-Precompilation-and-Binary-Building-1"></a><a class="docs-heading-anchor-permalink" href="#Working-with-Precompilation-and-Binary-Building" title="Permalink"></a></h1><h2 id="tl;dr,-I-just-want-precompilation-to-work"><a class="docs-heading-anchor" href="#tl;dr,-I-just-want-precompilation-to-work">tl;dr, I just want precompilation to work</a><a id="tl;dr,-I-just-want-precompilation-to-work-1"></a><a class="docs-heading-anchor-permalink" href="#tl;dr,-I-just-want-precompilation-to-work" title="Permalink"></a></h2><p>The tl;dr is, if you want to make precompilation work then instead of</p><pre><code class="language-julia hljs">ODEProblem(sys, u0, tspan, p)</code></pre><p>use:</p><pre><code class="language-julia hljs">ODEProblem(sys, u0, tspan, p, eval_module = @__MODULE__, eval_expression = true)</code></pre><p>As a full example, here&#39;s an example of a module that would precompile effectively:</p><pre><code class="language-julia hljs">module PrecompilationMWE
using ModelingToolkit

@variables x(ModelingToolkit.t_nounits)
@named sys = ODESystem([ModelingToolkit.D_nounits(x) ~ -x + 1], ModelingToolkit.t_nounits)
prob = ODEProblem(structural_simplify(sys), [x =&gt; 30.0], (0, 100), [],
    eval_expression = true, eval_module = @__MODULE__)

end</code></pre><p>If you use that in your package&#39;s code then 99% of the time that&#39;s the right answer to get precompilation working.</p><h2 id="I&#39;m-doing-something-fancier-and-need-a-bit-more-of-an-explanation"><a class="docs-heading-anchor" href="#I&#39;m-doing-something-fancier-and-need-a-bit-more-of-an-explanation">I&#39;m doing something fancier and need a bit more of an explanation</a><a id="I&#39;m-doing-something-fancier-and-need-a-bit-more-of-an-explanation-1"></a><a class="docs-heading-anchor-permalink" href="#I&#39;m-doing-something-fancier-and-need-a-bit-more-of-an-explanation" title="Permalink"></a></h2><p>Oh you dapper soul, time for the bigger explanation. Julia&#39;s <code>eval</code> function evaluates a function into a module at a specified world-age. If you evaluate a function within a function and try to call it from within that same function, you will hit a world-age error. This looks like:</p><pre><code class="language-julia hljs">function worldageerror()
    f = eval(:((x) -&gt; 2x))
    f(2)
end</code></pre><pre><code class="nohighlight hljs">julia&gt; worldageerror()
ERROR: MethodError: no method matching (::var&quot;#5#6&quot;)(::Int64)

Closest candidates are:
  (::var&quot;#5#6&quot;)(::Any) (method too new to be called from this world context.)
   @ Main REPL[12]:2</code></pre><p>This is done for many reasons, in particular if the code that is called within a function could change at any time, then Julia functions could not ever properly optimize because the meaning of any function or dispatch could always change and you would lose performance by guarding against that. For a full discussion of world-age, see <a href="https://arxiv.org/abs/2010.07516">this paper</a>.</p><p>However, this would be greatly inhibiting to standard ModelingToolkit usage because then something as simple as building an ODEProblem in a function and then using it would get a world age error:</p><pre><code class="language-julia hljs">function wouldworldage()
    prob = ODEProblem(sys, [], (0.0, 1.0))
    sol = solve(prob)
end</code></pre><p>The reason is because <code>prob.f</code> would be constructed via <code>eval</code>, and thus <code>prob.f</code> could not be called in the function, which means that no solve could ever work in the same function that generated the problem. That does mean that:</p><pre><code class="language-julia hljs">function wouldworldage()
    prob = ODEProblem(sys, [], (0.0, 1.0))
end
sol = solve(prob)</code></pre><p>is fine, or putting</p><pre><code class="language-julia hljs">prob = ODEProblem(sys, [], (0.0, 1.0))
sol = solve(prob)</code></pre><p>at the top level of a module is perfectly fine too. They just cannot happen in the same function.</p><p>This would be a major limitation to ModelingToolkit, and thus we developed <a href="https://github.com/SciML/RuntimeGeneratedFunctions.jl">RuntimeGeneratedFunctions</a> to get around this limitation. It will not be described beyond that, it is dark art and should not be investigated. But it does the job. But that does mean that it plays... oddly with Julia&#39;s compilation.</p><p>There are ways to force RuntimeGeneratedFunctions to perform their evaluation and caching within a given module, but that is not recommended because it does not play nicely with Julia v1.9&#39;s introduction of package images for binary caching.</p><p>Thus when trying to make things work with precompilation, we recommend using <code>eval</code>. This is done by simply adding <code>eval_expression=true</code> to the problem constructor. However, this is not a silver bullet because the moment you start using eval, all potential world-age restrictions apply, and thus it is recommended this is simply used for evaluating at the top level of modules for the purpose of precompilation and ensuring binaries of your MTK functions are built correctly.</p><p>However, there is one caveat that <code>eval</code> in Julia works depending on the module that it is given. If you have <code>MyPackage</code> that you are precompiling into, or say you are using <code>juliac</code> or PackageCompiler or some other static ahead-of-time (AOT) Julia compiler, then you don&#39;t want to accidentally <code>eval</code> that function to live in ModelingToolkit and instead want to make sure it is <code>eval</code>&#39;d to live in <code>MyPackage</code> (since otherwise it will not cache into the binary). ModelingToolkit cannot know that in advance, and thus you have to pass in the module you wish for the functions to &quot;live&quot; in. This is done via the <code>eval_module</code> argument.</p><p>Hence <code>ODEProblem(sys, u0, tspan, p, eval_module=@__MODULE__, eval_expression=true)</code> will work if you are running this expression in the scope of the module you wish to be precompiling. However, if you are attempting to AOT compile a different module, this means that <code>eval_module</code> needs to be appropriately chosen. And, because <code>eval_expression=true</code>, all caveats of world-age apply.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../DependencyGraphs/">« Dependency Graphs</a><a class="docs-footer-nextpage" href="../FAQ/">Frequently Asked Questions »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.9.0 on <span class="colophon-date" title="Sunday 23 March 2025 12:52">Sunday 23 March 2025</span>. Using Julia version 1.10.9.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
