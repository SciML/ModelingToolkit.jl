<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Symbolic-Numeric Perturbation Theory for ODEs · ModelingToolkit.jl</title><meta name="title" content="Symbolic-Numeric Perturbation Theory for ODEs · ModelingToolkit.jl"/><meta property="og:title" content="Symbolic-Numeric Perturbation Theory for ODEs · ModelingToolkit.jl"/><meta property="twitter:title" content="Symbolic-Numeric Perturbation Theory for ODEs · ModelingToolkit.jl"/><meta name="description" content="Documentation for ModelingToolkit.jl."/><meta property="og:description" content="Documentation for ModelingToolkit.jl."/><meta property="twitter:description" content="Documentation for ModelingToolkit.jl."/><meta property="og:url" content="https://docs.sciml.ai/ModelingToolkit/stable/examples/perturbation/"/><meta property="twitter:url" content="https://docs.sciml.ai/ModelingToolkit/stable/examples/perturbation/"/><link rel="canonical" href="https://docs.sciml.ai/ModelingToolkit/stable/examples/perturbation/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="ModelingToolkit.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ModelingToolkit.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../tutorials/ode_modeling/">Getting Started with ModelingToolkit.jl</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/acausal_components/">Acausal Component-Based Modeling</a></li><li><a class="tocitem" href="../../tutorials/nonlinear/">Modeling Nonlinear Systems</a></li><li><a class="tocitem" href="../../tutorials/initialization/">Initialization of Systems</a></li><li><a class="tocitem" href="../../tutorials/optimization/">Modeling Optimization Problems</a></li><li><a class="tocitem" href="../../tutorials/modelingtoolkitize/">Modelingtoolkitize: Automatically Translating Numerical to Symbolic Code</a></li><li><a class="tocitem" href="../../tutorials/programmatically_generating/">Programmatically Generating and Scripting Systems</a></li><li><a class="tocitem" href="../../tutorials/stochastic_diffeq/">Modeling with Stochasticity</a></li><li><a class="tocitem" href="../../tutorials/dynamic_optimization/">Solving Dynamic Optimization Problems</a></li><li><a class="tocitem" href="../../tutorials/discrete_system/">(Experimental) Modeling Discrete Systems</a></li><li><a class="tocitem" href="../../tutorials/parameter_identifiability/">Parameter Identifiability in ODE Models</a></li><li><a class="tocitem" href="../../tutorials/change_independent_variable/">Changing the independent variable of ODEs</a></li><li><a class="tocitem" href="../../tutorials/bifurcation_diagram_computation/">Bifurcation Diagrams</a></li><li><a class="tocitem" href="../../tutorials/attractors/">Multi- and Nonlocal- Continuation</a></li><li><a class="tocitem" href="../../tutorials/SampledData/">Clocks and Sampled-Data Systems</a></li><li><a class="tocitem" href="../../tutorials/domain_connections/">Domains</a></li><li><a class="tocitem" href="../../tutorials/callable_params/">Callable parameters and interpolating data</a></li><li><a class="tocitem" href="../../tutorials/linear_analysis/">Linear Analysis</a></li><li><a class="tocitem" href="../../tutorials/disturbance_modeling/">Disturbance and input modeling modeling</a></li><li><a class="tocitem" href="../../tutorials/fmi/">Importing FMUs</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Basic Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../higher_order/">Automatic Transformation of Nth Order ODEs to 1st Order ODEs</a></li><li><a class="tocitem" href="../spring_mass/">Component-Based Modeling of a Spring-Mass System</a></li><li><a class="tocitem" href="../modelingtoolkitize_index_reduction/">Automated Index Reduction of DAEs</a></li><li><a class="tocitem" href="../remake/">Optimizing through an ODE solve and re-creating MTK Problems</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Advanced Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../tearing_parallelism/">Exposing More Parallelism By Tearing Algebraic Equations in Systems</a></li><li><a class="tocitem" href="../sparse_jacobians/">Automated Sparse Analytical Jacobians</a></li><li class="is-active"><a class="tocitem" href>Symbolic-Numeric Perturbation Theory for ODEs</a><ul class="internal"><li><a class="tocitem" href="#Free-fall-in-a-varying-gravitational-field"><span>Free fall in a varying gravitational field</span></a></li><li><a class="tocitem" href="#Weakly-nonlinear-oscillator"><span>Weakly nonlinear oscillator</span></a></li></ul></li></ul></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../API/System/">The <code>System</code> type</a></li><li><a class="tocitem" href="../../API/variables/">Symbolic variables and variable metadata</a></li><li><a class="tocitem" href="../../API/model_building/">Model building reference</a></li><li><a class="tocitem" href="../../API/problems/">Building and solving numerical problems</a></li><li><a class="tocitem" href="../../API/dynamic_opt/">Dynamic Optimization Solvers</a></li><li><a class="tocitem" href="../../API/codegen/">Code generation utilities</a></li><li><a class="tocitem" href="../../API/PDESystem/">PDESystem</a></li></ul></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../../basics/Composition/">Composing Models and Building Reusable Components</a></li><li><a class="tocitem" href="../../basics/Events/">Event Handling and Callback Functions</a></li><li><a class="tocitem" href="../../basics/Linearization/">Linearization</a></li><li><a class="tocitem" href="../../basics/InputOutput/">Input output</a></li><li><a class="tocitem" href="../../basics/MTKLanguage/">ModelingToolkit Language: Modeling with <code>@mtkmodel</code>, <code>@connectors</code> and <code>@mtkcompile</code></a></li><li><a class="tocitem" href="../../basics/Validation/">Model Validation and Units</a></li><li><a class="tocitem" href="../../basics/Debugging/">Debugging</a></li><li><a class="tocitem" href="../../basics/DependencyGraphs/">Dependency Graphs</a></li><li><a class="tocitem" href="../../basics/Precompilation/">Working with Precompilation and Binary Building</a></li><li><a class="tocitem" href="../../basics/FAQ/">Frequently Asked Questions</a></li></ul></li><li><a class="tocitem" href="../../comparison/">Comparison of ModelingToolkit vs Equation-Based and Block Modeling Languages</a></li><li><span class="tocitem">Internal Details</span><ul><li><a class="tocitem" href="../../internals/">Internal Details</a></li><li><a class="tocitem" href="../../internals/structural_transformation/">Structural Transformation</a></li><li><a class="tocitem" href="../../internals/bipartite_graph/">Bipartite Graphs</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li><a class="is-disabled">Advanced Examples</a></li><li class="is-active"><a href>Symbolic-Numeric Perturbation Theory for ODEs</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Symbolic-Numeric Perturbation Theory for ODEs</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SciML/ModelingToolkit.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SciML/ModelingToolkit.jl/blob/master/docs/src/examples/perturbation.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="perturb_diff"><a class="docs-heading-anchor" href="#perturb_diff">Symbolic-Numeric Perturbation Theory for ODEs</a><a id="perturb_diff-1"></a><a class="docs-heading-anchor-permalink" href="#perturb_diff" title="Permalink"></a></h1><div class="admonition is-warning" id="Example-currently-disabled-7182dfde3ddc512a"><header class="admonition-header">Example currently disabled<a class="admonition-anchor" href="#Example-currently-disabled-7182dfde3ddc512a" title="Permalink"></a></header><div class="admonition-body"><p>This example demonstrates perturbation theory for ODEs but is currently non-executable due to compatibility issues between the <code>series()</code> and <code>taylor_coeff()</code> functions from Symbolics.jl and the current ModelingToolkit stack. The code is shown for educational purposes. See the <a href="https://symbolics.juliasymbolics.org/stable/tutorials/perturbation/">Mixed Symbolic-Numeric Perturbation Theory tutorial</a> for a working algebraic version.</p></div></div><p>In the <a href="https://symbolics.juliasymbolics.org/stable/tutorials/perturbation/">Mixed Symbolic-Numeric Perturbation Theory tutorial</a>, we discussed how to solve algebraic equations using <strong>Symbolics.jl</strong>. Here we extend the method to differential equations. The procedure is similar, but the Taylor series coefficients now become functions of an independent variable (usually time).</p><h2 id="Free-fall-in-a-varying-gravitational-field"><a class="docs-heading-anchor" href="#Free-fall-in-a-varying-gravitational-field">Free fall in a varying gravitational field</a><a id="Free-fall-in-a-varying-gravitational-field-1"></a><a class="docs-heading-anchor-permalink" href="#Free-fall-in-a-varying-gravitational-field" title="Permalink"></a></h2><p>Our first ODE example is a well-known physics problem: what is the altitude <span>$x(t)$</span> of an object (say, a ball or a rocket) thrown vertically with initial velocity <span>$ẋ(0)$</span> from the surface of a planet with mass <span>$M$</span> and radius <span>$R$</span>? According to Newton&#39;s second law and law of gravity, it is the solution of the ODE</p><p class="math-container">\[ẍ = -\frac{GM}{(R+x)^2} = -\frac{GM}{R^2} \frac{1}{\left(1+ϵ\frac{x}{R}\right)^2}.\]</p><p>In the last equality, we introduced a perturbative expansion parameter <span>$ϵ$</span>. When <span>$ϵ=1$</span>, we recover the original problem. When <span>$ϵ=0$</span>, the problem reduces to the trivial problem <span>$ẍ = -g$</span> with constant gravitational acceleration <span>$g = GM/R^2$</span> and solution <span>$x(t) = x(0) + ẋ(0) t - \frac{1}{2} g t^2$</span>. This is a good setup for perturbation theory.</p><p>To make the problem dimensionless, we redefine <span>$x \leftarrow x / R$</span> and <span>$t \leftarrow t / \sqrt{R^3/GM}$</span>. Then the ODE becomes</p><pre><code class="language-julia hljs">using ModelingToolkit
using ModelingToolkit: t_nounits as t, D_nounits as D
@variables ϵ x(t)
eq = D(D(x)) ~ -(1 + ϵ * x)^(-2)</code></pre><p>Next, expand <span>$x(t)$</span> in a series up to second order in <span>$ϵ$</span>:</p><pre><code class="language-julia hljs">using Symbolics
@variables y₀(t) y₁(t) y₂(t) # coefficients (y₀=0th order, y₁=1st, y₂=2nd)
x_series = series([y₀, y₁, y₂], ϵ)</code></pre><p>Insert this into the equation and collect perturbed equations to each order:</p><pre><code class="language-julia hljs">eq_pert = substitute(eq, x =&gt; x_series)
eqs_pert = taylor_coeff(eq_pert, ϵ, 0:2)</code></pre><div class="admonition is-info" id="Note-7189fd61737de24a"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-7189fd61737de24a" title="Permalink"></a></header><div class="admonition-body"><p>The 0-th order equation can be solved analytically, but ModelingToolkit does currently not feature automatic analytical solution of ODEs, so we proceed with solving it numerically.</p></div></div><p>These are the ODEs we want to solve. Now construct an <code>System</code>, which automatically inserts dummy derivatives for the velocities:</p><pre><code class="language-julia hljs">@mtkcompile sys = System(eqs_pert, t)</code></pre><p>To solve the <code>System</code>, we generate an <code>ODEProblem</code> with initial conditions <span>$x(0) = 0$</span>, and <span>$ẋ(0) = 1$</span>, and solve it:</p><pre><code class="language-julia hljs">using OrdinaryDiffEq
u0 = Dict([unknowns(sys) .=&gt; 0.0; D(y₀) =&gt; 1.0]) # nonzero initial velocity
prob = ODEProblem(sys, u0, (0.0, 3.0))
sol = solve(prob)</code></pre><p>This is the solution for the coefficients in the series for <span>$x(t)$</span> and their derivatives. Finally, we calculate the solution to the original problem by summing the series for different <span>$ϵ$</span>:</p><pre><code class="language-julia hljs">using Plots
p = plot()
for ϵᵢ in 0.0:0.1:1.0
    # Compute x(t) = y₀(t) + y₁(t)*ϵ + y₂(t)*ϵ² from solution values
    xs = sol[y₀] .+ ϵᵢ .* sol[y₁] .+ ϵᵢ^2 .* sol[y₂]
    plot!(p, sol.t, xs, label = &quot;ϵ = $ϵᵢ&quot;)
end
p</code></pre><p>This makes sense: for larger <span>$ϵ$</span>, gravity weakens with altitude, and the trajectory goes higher for a fixed initial velocity.</p><p>An advantage of the perturbative method is that we run the ODE solver only once and calculate trajectories for several <span>$ϵ$</span> for free. Had we solved the full unperturbed ODE directly, we would need to do repeat it for every <span>$ϵ$</span>.</p><h2 id="Weakly-nonlinear-oscillator"><a class="docs-heading-anchor" href="#Weakly-nonlinear-oscillator">Weakly nonlinear oscillator</a><a id="Weakly-nonlinear-oscillator-1"></a><a class="docs-heading-anchor-permalink" href="#Weakly-nonlinear-oscillator" title="Permalink"></a></h2><p>Our second example applies perturbation theory to nonlinear oscillators – a very important class of problems. As we will see, perturbation theory has difficulty providing a good solution to this problem, but the process is nevertheless instructive. This example closely follows chapter 7.6 of <em>Nonlinear Dynamics and Chaos</em> by Steven Strogatz.</p><p>The goal is to solve the ODE</p><pre><code class="language-julia hljs">eq = D(D(x)) + 2 * ϵ * D(x) + x ~ 0</code></pre><p>with initial conditions <span>$x(0) = 0$</span> and <span>$ẋ(0) = 1$</span>. With <span>$ϵ = 0$</span>, the problem reduces to the simple linear harmonic oscillator with the exact solution <span>$x(t) = \sin(t)$</span>.</p><p>We follow the same steps as in the previous example to construct the <code>System</code>:</p><pre><code class="language-julia hljs">eq_pert = substitute(eq, x =&gt; x_series)
eqs_pert = taylor_coeff(eq_pert, ϵ, 0:2)
@mtkcompile sys = System(eqs_pert, t)</code></pre><p>We solve and plot it as in the previous example, and compare the solution with <span>$ϵ=0.1$</span> to the exact solution <span>$x(t, ϵ) = e^{-ϵ t} \sin(\sqrt{(1-ϵ^2)}\,t) / \sqrt{1-ϵ^2}$</span> of the unperturbed equation:</p><pre><code class="language-julia hljs">u0 = [y₀ =&gt; 0.0, y₁ =&gt; 0.0, y₂ =&gt; 0.0, D(y₀) =&gt; 1.0, D(y₁) =&gt; 0.0, D(y₂) =&gt; 0.0] # nonzero initial velocity
prob = ODEProblem(sys, u0, (0.0, 50.0))
sol = solve(prob)
plot(sol, idxs = substitute(x_series, ϵ =&gt; 0.1); label = &quot;Perturbative (ϵ=0.1)&quot;)

x_exact(t, ϵ) = exp(-ϵ * t) * sin(√(1 - ϵ^2) * t) / √(1 - ϵ^2)
plot!(sol.t, x_exact.(sol.t, 0.1); label = &quot;Exact (ϵ=0.1)&quot;)</code></pre><p>This is similar to Figure 7.6.2 in <em>Nonlinear Dynamics and Chaos</em>. The two curves fit well for the first couple of cycles, but then the perturbative solution diverges from the exact solution. The main reason is that the problem has two or more time-scales that introduce secular terms in the solution. One solution is to explicitly account for the two time scales and use an analytic method called <em>two-timing</em>, but this is outside the scope of this example.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../sparse_jacobians/">« Automated Sparse Analytical Jacobians</a><a class="docs-footer-nextpage" href="../../API/System/">The <code>System</code> type »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Tuesday 27 January 2026 12:32">Tuesday 27 January 2026</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
