<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Optimizing through an ODE solve and re-creating MTK Problems · ModelingToolkit.jl</title><meta name="title" content="Optimizing through an ODE solve and re-creating MTK Problems · ModelingToolkit.jl"/><meta property="og:title" content="Optimizing through an ODE solve and re-creating MTK Problems · ModelingToolkit.jl"/><meta property="twitter:title" content="Optimizing through an ODE solve and re-creating MTK Problems · ModelingToolkit.jl"/><meta name="description" content="Documentation for ModelingToolkit.jl."/><meta property="og:description" content="Documentation for ModelingToolkit.jl."/><meta property="twitter:description" content="Documentation for ModelingToolkit.jl."/><meta property="og:url" content="https://docs.sciml.ai/ModelingToolkit/stable/examples/remake/"/><meta property="twitter:url" content="https://docs.sciml.ai/ModelingToolkit/stable/examples/remake/"/><link rel="canonical" href="https://docs.sciml.ai/ModelingToolkit/stable/examples/remake/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="ModelingToolkit.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">ModelingToolkit.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../tutorials/ode_modeling/">Getting Started with ModelingToolkit.jl</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/acausal_components/">Acausal Component-Based Modeling</a></li><li><a class="tocitem" href="../../tutorials/nonlinear/">Modeling Nonlinear Systems</a></li><li><a class="tocitem" href="../../tutorials/initialization/">Initialization of ODESystems</a></li><li><a class="tocitem" href="../../tutorials/optimization/">Modeling Optimization Problems</a></li><li><a class="tocitem" href="../../tutorials/modelingtoolkitize/">Modelingtoolkitize: Automatically Translating Numerical to Symbolic Code</a></li><li><a class="tocitem" href="../../tutorials/programmatically_generating/">Programmatically Generating and Scripting ODESystems</a></li><li><a class="tocitem" href="../../tutorials/stochastic_diffeq/">Modeling with Stochasticity</a></li><li><a class="tocitem" href="../../tutorials/discrete_system/">(Experimental) Modeling Discrete Systems</a></li><li><a class="tocitem" href="../../tutorials/parameter_identifiability/">Parameter Identifiability in ODE Models</a></li><li><a class="tocitem" href="../../tutorials/bifurcation_diagram_computation/">Bifurcation Diagrams</a></li><li><a class="tocitem" href="../../tutorials/SampledData/">Clocks and Sampled-Data Systems</a></li><li><a class="tocitem" href="../../tutorials/domain_connections/">Domains</a></li><li><a class="tocitem" href="../../tutorials/callable_params/">Callable parameters and interpolating data</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox" checked/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Basic Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../higher_order/">Automatic Transformation of Nth Order ODEs to 1st Order ODEs</a></li><li><a class="tocitem" href="../spring_mass/">Component-Based Modeling of a Spring-Mass System</a></li><li><a class="tocitem" href="../modelingtoolkitize_index_reduction/">Automated Index Reduction of DAEs</a></li><li class="is-active"><a class="tocitem" href>Optimizing through an ODE solve and re-creating MTK Problems</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Re-creating-the-problem"><span>Re-creating the problem</span></a></li><li><a class="tocitem" href="#Pure-remake"><span>Pure <code>remake</code></span></a></li><li><a class="tocitem" href="#remake-and-setp/setu"><span><code>remake</code> and <code>setp</code>/<code>setu</code></span></a></li><li><a class="tocitem" href="#replace-and-remake"><span><code>replace</code> and <code>remake</code></span></a></li><li><a class="tocitem" href="#remake-and-replace!"><span><code>remake</code> and <code>replace!</code></span></a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Advanced Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../tearing_parallelism/">Exposing More Parallelism By Tearing Algebraic Equations in ODESystems</a></li><li><a class="tocitem" href="../sparse_jacobians/">Automated Sparse Analytical Jacobians</a></li><li><a class="tocitem" href="../perturbation/">Symbolic-Numeric Perturbation Theory for ODEs</a></li></ul></li></ul></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../../basics/AbstractSystem/">The AbstractSystem Interface</a></li><li><a class="tocitem" href="../../basics/ContextualVariables/">Contextual Variable Types</a></li><li><a class="tocitem" href="../../basics/Variable_metadata/">Symbolic Metadata</a></li><li><a class="tocitem" href="../../basics/Composition/">Composing Models and Building Reusable Components</a></li><li><a class="tocitem" href="../../basics/Events/">Event Handling and Callback Functions</a></li><li><a class="tocitem" href="../../basics/Linearization/">Linearization</a></li><li><a class="tocitem" href="../../basics/InputOutput/">Input output</a></li><li><a class="tocitem" href="../../basics/MTKLanguage/">ModelingToolkit Language: Modeling with <code>@mtkmodel</code>, <code>@connectors</code> and <code>@mtkbuild</code></a></li><li><a class="tocitem" href="../../basics/Validation/">Model Validation and Units</a></li><li><a class="tocitem" href="../../basics/DependencyGraphs/">Dependency Graphs</a></li><li><a class="tocitem" href="../../basics/Precompilation/">Working with Precompilation and Binary Building</a></li><li><a class="tocitem" href="../../basics/FAQ/">Frequently Asked Questions</a></li></ul></li><li><span class="tocitem">System Types</span><ul><li><a class="tocitem" href="../../systems/ODESystem/">ODESystem</a></li><li><a class="tocitem" href="../../systems/SDESystem/">SDESystem</a></li><li><a class="tocitem" href="../../systems/JumpSystem/">JumpSystem</a></li><li><a class="tocitem" href="../../systems/NonlinearSystem/">NonlinearSystem</a></li><li><a class="tocitem" href="../../systems/OptimizationSystem/">OptimizationSystem</a></li><li><a class="tocitem" href="../../systems/PDESystem/">PDESystem</a></li></ul></li><li><a class="tocitem" href="../../comparison/">Comparison of ModelingToolkit vs Equation-Based and Block Modeling Languages</a></li><li><a class="tocitem" href="../../internals/">Internal Details</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li><a class="is-disabled">Basic Examples</a></li><li class="is-active"><a href>Optimizing through an ODE solve and re-creating MTK Problems</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Optimizing through an ODE solve and re-creating MTK Problems</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SciML/ModelingToolkit.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SciML/ModelingToolkit.jl/blob/master/docs/src/examples/remake.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Optimizing-through-an-ODE-solve-and-re-creating-MTK-Problems"><a class="docs-heading-anchor" href="#Optimizing-through-an-ODE-solve-and-re-creating-MTK-Problems">Optimizing through an ODE solve and re-creating MTK Problems</a><a id="Optimizing-through-an-ODE-solve-and-re-creating-MTK-Problems-1"></a><a class="docs-heading-anchor-permalink" href="#Optimizing-through-an-ODE-solve-and-re-creating-MTK-Problems" title="Permalink"></a></h1><p>Solving an ODE as part of an <code>OptimizationProblem</code>&#39;s loss function is a common scenario. In this example, we will go through an efficient way to model such scenarios using ModelingToolkit.jl.</p><p>First, we build the ODE to be solved. For this example, we will use a Lotka-Volterra model:</p><pre><code class="language-julia hljs">using ModelingToolkit
using ModelingToolkit: t_nounits as t, D_nounits as D

@parameters α β γ δ
@variables x(t) y(t)
eqs = [D(x) ~ (α - β * y) * x
       D(y) ~ (δ * x - γ) * y]
@mtkbuild odesys = ODESystem(eqs, t)</code></pre><p class="math-container">\[ \begin{align}
\frac{\mathrm{d} x\left( t \right)}{\mathrm{d}t} &amp;= x\left( t \right) \left( \alpha - y\left( t \right) \beta \right) \\
\frac{\mathrm{d} y\left( t \right)}{\mathrm{d}t} &amp;= \left(  - \gamma + x\left( t \right) \delta \right) y\left( t \right)
\end{align}
 \]</p><p>To create the &quot;data&quot; for optimization, we will solve the system with a known set of parameters.</p><pre><code class="language-julia hljs">using OrdinaryDiffEq

odeprob = ODEProblem(
    odesys, [x =&gt; 1.0, y =&gt; 1.0], (0.0, 10.0), [α =&gt; 1.5, β =&gt; 1.0, γ =&gt; 3.0, δ =&gt; 1.0])
timesteps = 0.0:0.1:10.0
sol = solve(odeprob, Tsit5(); saveat = timesteps)
data = Array(sol)
# add some random noise
data = data + 0.01 * randn(size(data))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×101 Matrix{Float64}:
 1.00463  1.05496   1.1424    1.26456  …  0.950877  0.977675  1.01519
 1.00621  0.824999  0.671838  0.56847     1.34728   1.1098    0.921314</code></pre><p>Now we will create the loss function for the Optimization solve. This will require creating an <code>ODEProblem</code> with the parameter values passed to the loss function. Creating a new <code>ODEProblem</code> is expensive and requires differentiating through the code generation process. This can be bug-prone and is unnecessary. Instead, we will leverage the <code>remake</code> function. This allows creating a copy of an existing problem with updating state/parameter values. It should be noted that the types of the values passed to the loss function may not agree with the types stored in the existing <code>ODEProblem</code>. Thus, we cannot use <code>setp</code> to modify the problem in-place. Here, we will use the <code>replace</code> function from SciMLStructures.jl since it allows updating the entire <code>Tunable</code> portion of the parameter object which contains the parameters to optimize.</p><pre><code class="language-julia hljs">using SymbolicIndexingInterface: parameter_values, state_values
using SciMLStructures: Tunable, replace, replace!

function loss(x, p)
    odeprob = p[1] # ODEProblem stored as parameters to avoid using global variables
    ps = parameter_values(odeprob) # obtain the parameter object from the problem
    ps = replace(Tunable(), ps, x) # create a copy with the values passed to the loss function
    # remake the problem, passing in our new parameter object
    newprob = remake(odeprob; p = ps)
    timesteps = p[2]
    sol = solve(newprob, AutoTsit5(Rosenbrock23()); saveat = timesteps)
    truth = p[3]
    data = Array(sol)
    return sum((truth .- data) .^ 2) / length(truth)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">loss (generic function with 1 method)</code></pre><p>Note how the problem, timesteps and true data are stored as model parameters. This helps avoid referencing global variables in the function, which would slow it down significantly.</p><p>We could have done the same thing by passing <code>remake</code> a map of parameter values. For example, let us enforce that the order of ODE parameters in <code>x</code> is <code>[α β γ δ]</code>. Then, we could have done:</p><pre><code class="language-julia hljs">remake(odeprob; p = [α =&gt; x[1], β =&gt; x[2], γ =&gt; x[3], δ =&gt; x[4]])</code></pre><p>However, passing a symbolic map to <code>remake</code> is significantly slower than passing it a parameter object directly. Thus, we use <code>replace</code> to speed up the process. In general, <code>remake</code> is the most flexible method, but the flexibility comes at a cost of performance.</p><p>We can perform the optimization as below:</p><pre><code class="language-julia hljs">using Optimization
using OptimizationOptimJL

# manually create an OptimizationFunction to ensure usage of `ForwardDiff`, which will
# require changing the types of parameters from `Float64` to `ForwardDiff.Dual`
optfn = OptimizationFunction(loss, Optimization.AutoForwardDiff())
# parameter object is a tuple, to store differently typed objects together
optprob = OptimizationProblem(
    optfn, rand(4), (odeprob, timesteps, data), lb = 0.1zeros(4), ub = 3ones(4))
sol = solve(optprob, BFGS())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">retcode: Success
u: 4-element Vector{Float64}:
 0.8995869522225024
 0.5914447517811144
 0.027307263792679486
 1.289448057248506e-12</code></pre><p>To identify which values correspond to which parameters, we can <code>replace!</code> them into the <code>ODEProblem</code>:</p><pre><code class="language-julia hljs">replace!(Tunable(), parameter_values(odeprob), sol.u)
odeprob.ps[[α, β, γ, δ]]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">4-element Vector{Float64}:
 0.8995869522225024
 0.5914447517811144
 1.289448057248506e-12
 0.027307263792679486</code></pre><p><code>replace!</code> operates in-place, so the values being replaced must be of the same type as those stored in the parameter object, or convertible to that type. For demonstration purposes, we can construct a loss function that uses <code>replace!</code>, and calculate gradients using <code>AutoFiniteDiff</code> rather than <code>AutoForwardDiff</code>.</p><pre><code class="language-julia hljs">function loss2(x, p)
    odeprob = p[1] # ODEProblem stored as parameters to avoid using global variables
    newprob = remake(odeprob) # copy the problem with `remake`
    # update the parameter values in-place
    replace!(Tunable(), parameter_values(newprob), x)
    timesteps = p[2]
    sol = solve(newprob, AutoTsit5(Rosenbrock23()); saveat = timesteps)
    truth = p[3]
    data = Array(sol)
    return sum((truth .- data) .^ 2) / length(truth)
end

# use finite-differencing to calculate derivatives
optfn2 = OptimizationFunction(loss2, Optimization.AutoFiniteDiff())
optprob2 = OptimizationProblem(
    optfn2, rand(4), (odeprob, timesteps, data), lb = 0.1zeros(4), ub = 3ones(4))
sol = solve(optprob2, BFGS())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">retcode: Success
u: 4-element Vector{Float64}:
 0.8997829480227474
 0.5915656658728919
 0.027309501997078496
 8.063229553280367e-20</code></pre><h1 id="Re-creating-the-problem"><a class="docs-heading-anchor" href="#Re-creating-the-problem">Re-creating the problem</a><a id="Re-creating-the-problem-1"></a><a class="docs-heading-anchor-permalink" href="#Re-creating-the-problem" title="Permalink"></a></h1><p>There are multiple ways to re-create a problem with new state/parameter values. We will go over the various methods, listing their use cases.</p><h2 id="Pure-remake"><a class="docs-heading-anchor" href="#Pure-remake">Pure <code>remake</code></a><a id="Pure-remake-1"></a><a class="docs-heading-anchor-permalink" href="#Pure-remake" title="Permalink"></a></h2><p>This method is the most generic. It can handle symbolic maps, initializations of parameters/states dependent on each other and partial updates. However, this comes at the cost of performance. <code>remake</code> is also not always inferable.</p><h2 id="remake-and-setp/setu"><a class="docs-heading-anchor" href="#remake-and-setp/setu"><code>remake</code> and <code>setp</code>/<code>setu</code></a><a id="remake-and-setp/setu-1"></a><a class="docs-heading-anchor-permalink" href="#remake-and-setp/setu" title="Permalink"></a></h2><p>Calling <code>remake(prob)</code> creates a copy of the existing problem. This new problem has the exact same types as the original one, and the <code>remake</code> call is fully inferred. State/parameter values can be modified after the copy by using <code>setp</code> and/or <code>setu</code>. This is most appropriate when the types of state/parameter values does not need to be changed, only their values.</p><h2 id="replace-and-remake"><a class="docs-heading-anchor" href="#replace-and-remake"><code>replace</code> and <code>remake</code></a><a id="replace-and-remake-1"></a><a class="docs-heading-anchor-permalink" href="#replace-and-remake" title="Permalink"></a></h2><p><code>replace</code> returns a copy of a parameter object, with the appropriate portion replaced by new values. This is useful for changing the type of an entire portion, such as during the optimization process described above. <code>remake</code> is used in this case to create a copy of the problem with updated state/unknown values.</p><h2 id="remake-and-replace!"><a class="docs-heading-anchor" href="#remake-and-replace!"><code>remake</code> and <code>replace!</code></a><a id="remake-and-replace!-1"></a><a class="docs-heading-anchor-permalink" href="#remake-and-replace!" title="Permalink"></a></h2><p><code>replace!</code> is similar to <code>replace</code>, except that it operates in-place. This means that the parameter values must be of the same types. This is useful for cases where bulk parameter replacement is required without needing to change types. For example, optimization methods where the gradient is not computed using dual numbers (as demonstrated above).</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../modelingtoolkitize_index_reduction/">« Automated Index Reduction of DAEs</a><a class="docs-footer-nextpage" href="../tearing_parallelism/">Exposing More Parallelism By Tearing Algebraic Equations in ODESystems »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Friday 13 December 2024 13:51">Friday 13 December 2024</span>. Using Julia version 1.10.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
